<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="./img/CodeCraft-removebg-preview.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="./css/conta.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="./css/footer.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@100;400;800&display=swap"
        rel="stylesheet">
    <script src="./js/sessao.js"></script>

    <title>CodeCraft - conta</title>
</head>

<body onload="validarSessao()">
    <header class="cabecalho">
        <div class="container">
            <div class="logo">
                <img src="./img/CodeCraft__2_-removebg-preview.png" alt="">
            </div>
            <nav class="cabecalho-navbar">
                <ul>
                    <li><a href="./index.html">HOME</a></li>
                    <div class="headerClick">
                        <li><button onclick="executar()">HTML & CSS</button></li>
                        <div id="sumir" class="sumirAparecer">
                            <a href="./programacaoHTML.html">HTML</a>
                            <a href="./programacaoCSS.html">CSS</a>
                        </div>
                    </div>
                    <li><a href="./quiz.html">QUIZ</a></li>
                    <li><a href="./sobre.html">SOBRE NÓS</a></li>
                </ul>
            </nav>
            <div id="user">

                <button id="btnNome" onclick="perfil()"><span id="b_nome"></span><i
                        class='bx bxs-chevron-down'></i></button>
                <div id="colAparecer">
                    <button><a href="./conta.html">Minha Conta<i class='bx bxs-user-circle'></i></a></button>
                    <button onclick="sair()" id="btnSair">Sair<i class='bx bx-exit'></i></button>
                </div>

            </div>
            <div id="cel" class="cadastroElogin">
                <a class="cl cadastro" href="./cadastro.html">Cadastro</a>
                <a class="cl login" href="./login.html">Login</a>
            </div>

        </div>
    </header>
    <main>
        <span id="mensagemErro" style="display: none;"></span>
        <div class="menu-lateral">
            <div class="foto">
                <img src="https://cdn-icons-png.flaticon.com/512/1547/1547183.png" alt="">
            </div>
            <div class="navegacao">
                <button onclick="dado()">Dados da conta</button>
                <button onclick="anali()">Analytics</button>
            </div>
        </div>
        <div id="dados">
            <h2>Meus Dados</h2>

            <div class="conteudoUsuario">
                <div class="infoUsuario">
                    <h3>Nome:</h3>
                    <p id="usuario_nome"></p>
                </div>
                <hr>

                <div class="infoUsuario">
                    <h3>Email:</h3>
                    <p id="b_email"></p>
                </div>
                <hr>
                <div class="infoUsuario">
                    <h3>Telefone:</h3>
                    <p id="b_telefone"></p>
                </div>
                <hr class="marginB">
                <div id="bxEn" class="enderecoBox">
                    <input id="iptCep" type="text" placeholder="CEP"><span id="cepErro" style="display: none;">Cep precisa ter 8 dígitos</span>
                    
                    <input id="iptCidade" type="text" placeholder="CIDADDE">
                    <input id="iptBairro" type="text" placeholder="BAIRRO">
                    <input id="iptRua" type="text" placeholder="RUA">
                    <input id="iptNumero" type="text" placeholder="NUMERO DA CASA">
                    <button class="btnEndereco" onclick="cadastrarEndereco()">Cadastrar Endereço</button>
                </div>
                <div style="display: none;" id="mensagem_erro"></div>
            </div>
        </div>
        <div id="analytics">
            <div class="kpis">
                <div class="box">
                    <h3>Quantidade de Quiz realizado</h3>
                    <h5 id="tTotal"></h5>
                </div>
                <div class="box">
                    <h3>Quantidade de Quiz de Html realizado</h3>
                    <h5 id="tHtml"></h5>
                </div>
                <div class="box">
                    <h3>Quantidade de Quiz de Css realizado</h3>
                    <h5 id="tCss"></h5>
                </div>
            </div>
            <div class="graficosGeral">
                <div class="graficos">
                    <h3>Quiz HTML</h3>
                    <canvas id="myChart"></canvas>
                </div>
                <div class="graficos">
                    <h3>Quiz CSS</h3>
                    <canvas id="myChart2"></canvas>
                </div>
            </div>

        </div>
    </main>

    <footer>
        <div class="container">
            <img src="./img/CodeCraft__2_-removebg-preview.png" alt="">
            <div class="navegar">
                <p class="footerTitulo">Navegação</p>
                <ul>
                    <li><a href="./index.html">HOME</a></li>
                    <li><a href="#">HTML & CSS</a></li>
                    <li><a href="#">QUIZ</a></li>
                    <li><a href="#">SOBRE NÓS</a></li>
                </ul>
            </div>
            <div class="contato">
                <p class="footerTitulo">Contato</p>
                <i class='bx bxl-instagram'></i>
                <p class="footerTexto">codecraft@gmail.com</p>
            </div>
            <div class="criador">
                <p class="footerTitulo">Criador</p>
                <p class="footerTexto marginB">Igor Anthony De Jesus Maciel</p>
                <p class="footerTexto">Aluno da Sptech School</p>
            </div>
        </div>
    </footer>
    <script src="./js/header.js"></script>
</body>

</html>
<script>
    async function cadastrarEndereco() {
        var cep = iptCep.value
        var cidade = iptCidade.value
        var bairro = iptBairro.value
        var rua = iptRua.value
        var nmrCasa = iptNumero.value


        var idUsuario = sessionStorage.ID_USUARIO
        if(cep.length == 8 && cidade != '' && bairro != '' && rua != '' && nmrCasa != ''){
            var response = await fetch("/usuarios/cadastrarEndereco", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                cepServer: cep,
                cidadeServer: cidade,
                bairroServer: bairro,
                ruaServer: rua,
                nmrCasaServer: nmrCasa,
                idUsuarioServer: idUsuario,
            }),
        });

        if (response.ok) {
            sessionStorage.setItem('CEP_USUARIO', cep);
            cepErro.style.display = 'none'
            
            mensagemErro.style.display = 'flex'
          mensagemErro.innerHTML =
            `<i class='bx bx-checkbox-checked'></i>Endereço cadastrado com sucesso`;

            setTimeout(()=>{
                
                window.location = "./conta.html";
            },'2000')
        }
        
        bxEn.style.display = 'none'
        return false;
        } else {
            cepErro.style.display = 'block'
            mensagemErro.style.display = 'block'
          mensagemErro.innerHTML =
            `Campos invalidos!`;
            setTimeout(()=>{
                mensagemErro.style.display = 'none'
            },'4000')
        }
    }


    const dataDashboardHtml = {
        labels: [],
        datasets: [{
            label: 'Acertos',
            backgroundColor: '#00d9ff',
            data: [],
            borderWidth: 1,
        },
        {
            label: 'Erros',
            backgroundColor: 'rgb(255, 83, 83)',
            data: [],
            borderWidth: 1,
        }]
    }

    const dataDashboardCss = {
        labels: [],
        datasets: [{
            label: 'Acertos',
            backgroundColor: '#00d9ff',
            data: [],
            borderWidth: 1,
        },
        {
            label: 'Erros',
            backgroundColor: 'rgb(255, 83, 83)',
            data: [],
            borderWidth: 1,
        }]
    }

    const options = {

        scales: {
            x: {
                grid: {
                    color: 'white' // Mudar a cor da grade no eixo x
                },
                ticks: {
                    color: 'white' // Cor das labels no eixo x
                }
            },
            y: {
                grid: {
                    color: 'white' // Mudar a cor da grade no eixo y
                },
                ticks: {
                    color: 'white' // Cor das labels no eixo x
                }
            }
        },
        plugins: {
            legend: {
                display: true,
                labels: {
                    color: 'white'
                }
            }
        }
    }

    const ctx = document.getElementById('myChart');
    var htmlChart = new Chart(ctx, {
        type: 'bar',
        data: dataDashboardHtml,
        options
    });

    const ctx2 = document.getElementById('myChart2');
    var cssChart = new Chart(ctx2, {
        type: 'bar',
        data: dataDashboardCss,
        options
    });

    function dado() {
        dados.style.display = 'block'
        analytics.style.display = 'none'
    }

    async function anali() {
        dados.style.display = 'none'
        analytics.style.display = 'block'
        var idUsuario = sessionStorage.ID_USUARIO

        var resultado = await fetch("/usuarios/analytics", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario,
            }),
        });

        const resposta = await resultado.json();

        tHtml.innerHTML = resposta.tentativaQuizHtml
        tCss.innerHTML = resposta.tentativaQuizCss
        tTotal.innerHTML = resposta.totalQuizRealizado


        var resultadoDashboard = await fetch("/usuarios/analytics/dashboard", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idUsuarioServer: idUsuario,
            }),
        });

        var response = await resultadoDashboard.json();

        onUpdateChartHtml(response);
        onUpdateChartCSS(response);
    }

    const onUpdateChartHtml = ({ dadosQuizHtml }) => {
        var labels = dadosQuizHtml.map((args, index) => `Tentativa - ${index + 1}`)

        var acertosHtml = dadosQuizHtml.map(args => args.qtdAcertosHtml);
        var errosHtml = dadosQuizHtml.map(args => args.qtdErrosHtml);

        dataDashboardHtml.labels = labels;
        dataDashboardHtml.datasets[0].data = acertosHtml;
        dataDashboardHtml.datasets[1].data = errosHtml;

        htmlChart.update();
    };

    const onUpdateChartCSS = ({ dadosQuizCss }) => {
        var labels = dadosQuizCss.map((args, index) => `Tentativa - ${index + 1}`)

        var acertosCss = dadosQuizCss.map(args => args.qtdAcertosCss);
        var errosCss = dadosQuizCss.map(args => args.qtdErrosCss);

        dataDashboardCss.labels = labels;
        dataDashboardCss.datasets[0].data = acertosCss;
        dataDashboardCss.datasets[1].data = errosCss;

        cssChart.update();
    };

</script>